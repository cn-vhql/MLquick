# 期货行情预测平台

基于Streamlit和机器学习的期货行情预测平台，支持回归和分类两种预测模式，提供完整的期货数据分析和预测工作流。

## 功能特点

- 📈 支持多种期货品种（覆盖所有主要期货交易所）
- 📊 自动获取实时行情数据（通过akshare API）
- 🔧 智能特征工程（技术指标计算和特征生成）
- 🤖 多种机器学习模型对比和性能评估
- 📊 **专业级Matplotlib K线图**（支持成交量、移动平均线）
- 📊 丰富的可视化结果展示（完整工作流）
- ⚙️ 灵活的参数配置（时间范围、预测参数）
- 🎯 用户自定义期货品种代码输入
- 📅 **时间范围选择**：支持自定义数据获取时间段
- 📑 **标签化界面**：6个主要工作流程标签页
- 🔮 **未来预测报告**：基于最佳模型生成未来1-15天的行情预测

## 预测模式

### 1. 回归预测
- **预测目标**：未来指定天数的价格涨跌幅百分比
- **支持模型**：
  - 线性回归 (Linear Regression)
  - 岭回归 (Ridge Regression)
  - 随机森林 (Random Forest)
  - 梯度提升 (Gradient Boosting)
- **评估指标**：R²分数、均方误差(MSE)、预测散点图

### 2. 分类预测
- **预测目标**：未来指定天数的涨跌方向（上涨/震荡/下跌）
  - 上涨 (Up)：价格变化 > 1%
  - 震荡 (Sideways)：-1% ≤ 价格变化 ≤ 1%
  - 下跌 (Down)：价格变化 < -1%
- **支持模型**：
  - 随机森林 (Random Forest)
  - 直方图梯度提升 (Hist Gradient Boosting)
  - 逻辑回归 (Logistic Regression)
- **评估指标**：准确率、混淆矩阵、分类报告、各类别准确率

## 参数配置

### 基础参数
- **期货品种代码**：用户自定义输入（如CU0、RB0等）
- **时间范围选择**：支持自定义起止日期（默认最近90天）
- **历史数据天数**：用于特征工程的历史数据长度（默认7日）
- **预测天数**：预测未来的天数（默认3日）
- **训练集比例**：用于模型训练的数据比例（默认0.7）

### 模型参数
- **预测类型**：回归预测（价格变化百分比）或分类预测（涨跌方向）
- **特征工程**：自动计算技术指标（MA5、MA10、MA20、RSI、MACD、布林带等）

## 安装依赖

```bash
pip install -r requirements_futures.txt
```

**重要提示**：平台使用Matplotlib进行图表绘制，无需额外的图表库依赖。

## 运行平台

```bash
streamlit run futures_prediction_platform.py
```

## 使用说明

### 基本操作流程
1. **选择期货品种**：在侧边栏输入期货品种代码（如CU0、RB0等）
2. **设置时间范围**：选择数据获取的起止日期
3. **配置预测参数**：设置历史天数、预测天数、训练集比例等
4. **选择预测类型**：回归预测或分类预测
5. **开始分析**：点击"开始预测"按钮
6. **生成预测**：在"未来预测报告"标签页中设置预测参数并生成预测报告

### 分析工作流程（6个主要标签页）
1. **📊 原始数据**：查看获取的期货数据基本信息和预览
2. **📈 价格走势图**：专业的Matplotlib K线图，包含成交量和移动平均线
3. **🔧 特征工程**：查看特征矩阵、目标变量分布和技术指标详情
4. **🤖 模型训练与预测**：多模型对比、性能评估和结果可视化
5. **📊 特征重要性**：分析各特征对预测结果的贡献度
6. **🔮 未来预测报告**：基于最佳模型生成未来行情预测和详细分析报告

### K线图功能特性
- 🔴 **红色K线**：上涨 | 🟢 **绿色K线**：下跌（中国期货市场惯例）
- **技术指标**：MA5、MA10、MA20移动平均线
- **成交量柱状图**：对应K线颜色显示
- **数据摘要**：显示开盘价、收盘价、期间涨跌幅等关键信息
- **性能优化**：大数据集自动限制显示最近200天数据

### 🔮 未来预测报告功能
- **智能预测**：基于训练的最佳模型进行未来1-15天价格预测
- **预测控制**：可调节预测天数、置信区间显示等参数
- **可视化展示**：历史价格与预测趋势对比图表
- **置信区间**：回归模式提供价格预测的置信范围
- **趋势判断**：分类模式提供涨跌方向和置信度
- **详细报告**：生成包含每日预测的完整分析报告
- **报告下载**：支持下载文本格式的预测报告
- **风险提示**：包含完整的投资风险免责声明

## 支持的期货品种

平台支持用户自定义输入任意期货品种代码，覆盖所有主要期货交易所的品种：

### 🔸 有色金属
- CU0 (沪铜主力)、AL0 (沪铝主力)、ZN0 (沪锌主力)、NI0 (沪镍主力)
- SN0 (沪锡主力)、PB0 (沪铅主力)

### 🔸 黑色金属
- RB0 (螺纹钢主力)、HC0 (热轧卷板主力)、I0 (铁矿石主力)
- J0 (焦炭主力)、JM0 (焦煤主力)、ZC0 (动力煤主力)

### 🔸 能源化工
- SC0 (原油主力)、FU0 (燃油主力)、BU0 (沥青主力)
- TA0 (PTA主力)、MA0 (甲醇主力)、V0 (PVC主力)
- PP0 (PP主力)、L0 (LLDPE主力)

### 🔸 农产品
- M0 (豆粕主力)、Y0 (豆油主力)、P0 (棕榈油主力)
- C0 (玉米主力)、CS0 (淀粉主力)、CF0 (棉花主力)
- SR0 (白糖主力)、AP0 (苹果主力)、JD0 (鸡蛋主力)

### 🔸 贵金属
- AU0 (黄金主力)、AG0 (白银主力)

### 🔸 金融期货
- IF0 (沪深300股指)、IH0 (上证50股指)、IC0 (中证500股指)
- T0 (十年国债)、TF0 (五年国债)

**使用说明**：在平台侧边栏输入期货品种代码即可，平台会自动验证并获取对应数据。

## 技术指标

平台自动计算以下技术指标作为特征：

### 移动平均线类
- **MA5**：5日移动平均线
- **MA10**：10日移动平均线
- **MA20**：20日移动平均线

### 动量指标类
- **RSI**：相对强弱指标（14日周期）
- **MACD**：指数平滑异同移动平均线
- **Signal**：MACD信号线（9日EMA）
- **Histogram**：MACD柱状图

### 波动率指标类
- **Bollinger Bands**：布林带（20日±2标准差）
  - BB_upper：上轨
  - BB_middle：中轨（20日MA）
  - BB_lower：下轨

### 价格变化类
- **price_change**：1日价格变化率
- **price_change_3d**：3日价格变化率
- **price_change_5d**：5日价格变化率

这些技术指标将用于特征工程，为机器学习模型提供丰富的市场分析维度。

## 使用示例

### 启动方式
```bash
# 方式1：直接启动（推荐）
streamlit run futures_prediction_platform.py

# 方式2：使用启动脚本
python run_futures_platform.py
```

启动后平台将在浏览器中打开，默认地址为 `http://localhost:8501`

### 代码调用示例

```python
import sys
sys.path.append('/vda1/data/ai_quick')
from futures_prediction_platform import (
    get_futures_data,
    calculate_technical_indicators,
    create_features_targets,
    regression_prediction,
    classification_prediction
)

# 回归预测示例（预测价格变化百分比）
df = get_futures_data('CU0', days=100)  # 获取沪铜100天数据
df_processed = calculate_technical_indicators(df)  # 计算技术指标

# 创建特征和目标变量
X, y = create_features_targets(
    df_processed,
    historical_days=7,      # 使用过去7天数据
    prediction_days=3,      # 预测未来3天
    task_type='regression'  # 回归预测涨跌幅
)

# 训练模型
results, best_model, X_test, y_test = regression_prediction(X, y, train_size=0.7)

# 查看结果
for name, result in results.items():
    print(f"{name}: R² = {result['r2']:.4f}")

# 分类预测示例（预测涨跌方向）
X, y = create_features_targets(
    df_processed,
    historical_days=7,      # 使用过去7天数据
    prediction_days=3,      # 预测未来3天
    task_type='classification'  # 分类预测涨跌方向
)

# 训练分类模型
results, best_model, X_test, y_test = classification_prediction(X, y, train_size=0.7)

# 查看结果
for name, result in results.items():
    print(f"{name}: 准确率 = {result['accuracy']:.4f}")
```

### 期货品种列表
```python
futures_options = {
    '沪铜主力': 'CU0',
    '沪铝主力': 'AL0',
    '沪锌主力': 'ZN0',
    '沪镍主力': 'NI0',
    '螺纹钢主力': 'RB0',
    '热轧卷板主力': 'HC0',
    '铁矿石主力': 'I0',
    '焦炭主力': 'J0',
    '焦煤主力': 'JM0',
    '原油主力': 'SC0'
}
```

### 快速测试
```python
# 简单测试数据获取
df = get_futures_data('CU0', days=50)
print(f"获取到 {len(df)} 条数据")
print(df.head())

# 测试技术指标计算
df_processed = calculate_technical_indicators(df)
print(f"技术指标列数: {len(df_processed.columns)}")
print(df_processed[['close', 'MA5', 'MA10', 'RSI']].head())
```

## 平台特色功能

### 时间范围选择
- 支持自定义起止日期
- 智能数据过滤和验证
- 实际数据范围显示
- 大数据集性能优化

### 特征工程详情
- 历史价格和成交量特征
- 技术指标自动计算（MA、RSI、MACD、布林带等）
- 特征矩阵可视化展示
- 目标变量统计分析

### 模型性能评估
- **回归模式**：R²分数、MSE、预测散点图、模型对比柱状图
- **分类模式**：准确率、混淆矩阵、分类报告、各类别准确率分析
- **自动对比**：多模型性能对比，自动选择最佳模型
- **智能处理**：动态类别处理，避免标签错位问题
- **可视化**：模型性能对比图表和预测结果可视化

### 可视化图表
- 专业级Matplotlib K线图
- 技术指标叠加显示
- 成交量柱状图
- 模型性能对比图表
- 特征重要性分析图
- **未来预测趋势图**：历史价格与预测趋势对比
- **置信区间可视化**：回归模式的预测不确定性展示

### 未来预测算法
- **特征工程**：基于最新历史数据和技术指标构建预测特征
- **回归预测**：使用最佳回归模型预测具体价格变化幅度
- **分类预测**：使用最佳分类模型预测涨跌趋势方向
- **置信度计算**：提供预测结果的可信度评估
- **复合增长模型**：基于预测变化率计算未来价格路径
- **风险量化**：通过置信区间和波动性指标评估预测风险

## 故障排除

### 常见问题
1. **数据获取失败**：检查网络连接和期货代码有效性
2. **图表显示异常**：确认数据格式和数值有效性
3. **模型训练失败**：检查数据量是否足够（建议至少30天数据）
4. **预测结果异常**：查看特征工程详情和数据分布

### 优化建议
- 数据量推荐：≥30天用于基础分析，≥90天获得更好效果
- 参数设置：历史数据天数建议5-10天，预测天数1-5天
- 品种选择：建议选择主力合约（代码带0），流动性更好

## 注意事项

1. **数据来源**：平台使用akshare获取公开数据，请确保网络连接正常
2. **数据量要求**：获取数据天数应大于历史数据天数+预测天数
3. **投资风险**：预测结果仅供参考，不构成投资建议
4. **市场风险**：期货市场波动较大，请谨慎投资
5. **模型局限**：基于历史数据，无法保证未来预测准确性
6. **技术要求**：Python 3.7+，建议使用虚拟环境

## 更新日志

- **v2.1**：新增未来预测报告功能，支持1-15天行情预测和详细报告生成
- **v2.0**：完全英文化界面，修复图表显示问题，优化时间范围选择
- **v1.5**：添加特征工程详情展示，改进可视化效果
- **v1.2**：修复数据处理错误，支持动态类别处理
- **v1.0**：基础功能实现，支持回归和分类预测

## 未来预测功能使用指南

### 使用步骤
1. **完成模型训练**：首先在"模型训练与预测"标签页完成模型训练
2. **进入预测页面**：切换到"未来预测报告"标签页
3. **设置预测参数**：
   - 调整预测天数（1-15天）
   - 选择是否显示置信区间
   - 选择是否生成详细报告
4. **生成预测**：点击"生成未来预测"按钮
5. **查看结果**：
   - 预测摘要指标
   - 可视化趋势图
   - 详细预测数据表
   - 完整分析报告

### 预测结果说明
- **回归模式**：提供具体的价格预测和置信区间
- **分类模式**：提供涨跌趋势和置信度
- **可视化图表**：包含历史价格和预测趋势的完整走势图
- **风险提示**：所有预测结果都包含投资风险免责声明

### 技术原理
- 使用训练数据中表现最佳的机器学习模型
- 基于最新的历史数据和技术指标进行特征构建
- 采用复合增长模型计算未来价格路径
- 通过统计方法提供预测不确定性量化